<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload .docx file</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* 여기에 필요한 스타일을 추가하세요. */
    </style>
</head>
<body>
    <h2>찾고싶은 파일을 업로드 해주세요.</h2>
    <form action="/summary/" enctype="multipart/form-data" method="post">
        <input type="file" name="file">
        <input type="submit" value="Upload">
    </form>
    <div id="summaryContainer">
        <div class="summaryBox" id="similarDocumentsBox">
            <h2>유사한 파일</h2>
            <!-- 여기에 유사한 파일 목록이 들어갑니다. -->
        </div>
        <div class="summaryBox" id="summaryBox">
            <h2>업로드 파일 요약본</h2>
            <!-- 여기에 업로드된 파일의 요약이 들어갑니다. -->
        </div>
    </div>
    <div id="similarSummaryContainer">
        <h2>유사한 파일 요약본</h2>
        <!-- 여기에 유사한 파일들의 요약이 들어갑니다. -->
    </div>
    <script>
        $(document).ready(function() {
            $('form').on('submit', function(event) {
                event.preventDefault();

                var formData = new FormData(this);

                $.ajax({
                    url: '/summary/',
                    type: 'POST',
                    data: formData,
                    success: handleSummaryResponse,
                    error: function() {
                        $('#summaryContainer').html('<p>요약 중 오류가 발생했습니다.</p>');
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });
        });

        function handleSummaryResponse(data) {
            renderSimilarDocuments(data.similar_documents);
            renderFileSummary(data.kobart_summary);
            
            if (data.similar_documents.length > 0) {
                data.similar_documents.forEach(fetchAndRenderSimilarSummary);
            }
        }

        function renderSimilarDocuments(docs) {
            const html = docs.map(doc => {
                const downloadLink = `/file/?path=${encodeURIComponent(doc[1])}`;
                const docTitle = doc[1].split('/').pop();
                const similarity = doc[0];
                return `<div><a href="${downloadLink}" download="${doc[1]}">${docTitle}</a> | 유사도: ${similarity}</div>`;
            }).join('');
            $('#similarDocumentsBox').append(html);
        }

        function renderFileSummary(summary) {
            $('#summaryBox').append(`<div>${summary}</div>`);
        }

        function fetchAndRenderSimilarSummary(doc) {
            const documentPath = doc[1];
            const docTitle = doc[1].split('/').pop();

            $.ajax({
                url: '/summary_by_path/',
                type: 'POST',
                data: { path: documentPath },
                success: function(summaryData) {
                    const html = `<h3>${docTitle} 요약내용</h3><div>${summaryData.kobart_summary}</div>`;
                    $('#similarSummaryContainer').append(html);
                },
                error: function() {
                    $('#similarSummaryContainer').append(`<p>${doc[0]} 요약 중 오류가 발생했습니다.</p>`);
                }
            });
        }
    </script>
</body>
</html>
